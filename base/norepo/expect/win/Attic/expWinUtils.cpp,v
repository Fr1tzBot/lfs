head	1.1;
access;
symbols
	win32-jump-point-1:1.1.2.6
	telco-tec-win32-take2-branch:1.1.0.2;
locks; strict;
comment	@// @;


1.1
date	2002.03.11.00.32.45;	author davygrvy;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2002.03.11.00.32.45;	author davygrvy;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2002.03.11.06.56.02;	author davygrvy;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2002.03.11.07.03.35;	author davygrvy;	state Exp;
branches;
next	1.1.2.4;

1.1.2.4
date	2002.03.12.01.38.19;	author davygrvy;	state Exp;
branches;
next	1.1.2.5;

1.1.2.5
date	2002.03.12.07.59.14;	author davygrvy;	state Exp;
branches;
next	1.1.2.6;

1.1.2.6
date	2002.03.16.00.37.01;	author davygrvy;	state Exp;
branches;
next	1.1.2.7;

1.1.2.7
date	2002.06.18.22.51.31;	author davygrvy;	state Exp;
branches;
next	1.1.2.8;

1.1.2.8
date	2002.07.03.02.50.05;	author davygrvy;	state Exp;
branches;
next	1.1.2.9;

1.1.2.9
date	2003.08.26.20.46.54;	author davygrvy;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file expWinUtils.cpp was initially added on branch telco-tec-win32-take2-branch.
@
text
@@


1.1.2.1
log
@Moved BuildCommandLine out of the ConsoleDebugger class for testing reasons.
@
text
@a0 100
#include "expWinUtils.hpp"
#include <ctype.h>
#include <string.h>

/*
 *----------------------------------------------------------------------
 *
 * ArgMaker::BuildCommandLine --
 *
 *	Takes an array form and turns it into a single string according
 *	to the rules of quoting needed for windows.
 *
 * Results:
 *	The new string.
 *
 * Side Effects:
 *	Memory is allocated.
 *
 *----------------------------------------------------------------------
 */

char *
ArgMaker::BuildCommandLine(
    int argc,			// Number of arguments.
    char *const *argv)		// Argument strings (in ascii).
{
    const char *arg, *start, *special;
    char *out;
    int quote, i, need = 0;

    // Guess how large we are.
    for (i = 0; i < argc; i++) {
	need += strlen(argv[i]) + 10;
    }

    out = new char [need];

    for (i = 0; i < argc; i++) {
	arg = argv[i];
	if (i != 0) {
	    strcat(out, " ");
	} else {
	    *out = '\0';
	}

	quote = 0;
	if (arg[0] == '\0') {
	    quote = 1;
	} else {
	    // We quote the entire arguement when a space is found in it.
	    for (start = arg; *start != '\0'; start++) {
		if (isspace(*start)) {
		    quote = 1;
		    break;
		}
	    }
	}
	if (quote) {
	    strcat(out, "\"");
	}

	start = arg;	    
	for (special = arg; ; ) {
	    if ((*special == '\\') && 
		    (special[1] == '\\' || special[1] == '"')) {
		strncat(out, start, special - start);
		start = special;
		while (1) {
		    special++;
		    if (*special == '"') {
			// N backslashes followed a quote -> insert 
			// N * 2 + 1 backslashes then a quote.
			strncat(out, start, special - start);
			break;
		    }
		    if (*special != '\\') {
			break;
		    }
		}
		strncat(out, start, special - start);
		start = special;
	    }
	    if (*special == '"') {
		strncat(out, start, special - start);
		// replace a single double quote with 2 double quotes.
		strcat(out, "\"\"");
		start = special + 1;
	    }
	    if (*special == '\0') {
		break;
	    }
	    special++;
	}
	strncat(out, start, special - start);
	if (quote) {
	    strcat(out, "\"");
	}
    }
    return out;
}
@


1.1.2.2
log
@added missing file header comments
@
text
@a0 28
/* ----------------------------------------------------------------------------
 * expWinUtils.cpp --
 *
 *	Misc stuff.
 *
 * ----------------------------------------------------------------------------
 *
 * Written by: Don Libes, libes@@cme.nist.gov, NIST, 12/3/90
 * 
 * Design and implementation of this program was paid for by U.S. tax
 * dollars.  Therefore it is public domain.  However, the author and NIST
 * would appreciate credit if this program or parts of it are used.
 * 
 * Copyright (c) 1997 Mitel Corporation
 *	work by Gordon Chaffee <chaffee@@bmrc.berkeley.edu> for the WinNT port.
 *
 * Copyright (c) 2001-2002 Telindustrie, LLC
 *	work by David Gravereaux <davygrvy@@pobox.com> for any Win32 OS.
 *
 * ----------------------------------------------------------------------------
 * URLs:    http://expect.nist.gov/
 *	    http://expect.sf.net/
 *	    http://bmrc.berkeley.edu/people/chaffee/expectnt.html
 * ----------------------------------------------------------------------------
 * RCS: @@(#) $Id: expWinSpawnPipeClient.cpp,v 1.1.2.2 2002/03/11 06:53:39 davygrvy Exp $
 * ----------------------------------------------------------------------------
 */

@


1.1.2.3
log
@minor lint
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.2 2002/03/11 06:56:02 davygrvy Exp $
d57 1
a57 1
    int quote, i, need;
d60 1
a60 1
    for (i = need = 0; i < argc; i++) {
@


1.1.2.4
log
@Message class pulled-out to a seperate source file, due to expected growth in that area.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.3 2002/03/11 07:03:35 davygrvy Exp $
a64 1
    *out = '\0';
d70 2
d78 1
d80 1
a80 1
		if (isspace(*start) || *start == '"' ) {
d92 20
a111 1
	    if (*special == '"' && quote) {
a127 113
}

/*
 *-------------------------------------------------------------------------
 *
 * SetArgv --
 *
 *	Parse the Windows command line string into argc/argv.  Done here
 *	because we don't trust the builtin argument parser in crt0.  
 *	Windows applications are responsible for breaking their command
 *	line into arguments.
 *
 *	2N backslashes + quote -> N backslashes + begin quoted string
 *	2N + 1 backslashes + quote -> literal
 *	N backslashes + non-quote -> literal
 *	quote + quote in a quoted string -> single quote
 *	quote + quote not in quoted string -> empty string
 *	quote -> begin quoted string
 *
 * Results:
 *	Fills argcPtr with the number of arguments and argvPtr with the
 *	array of arguments.
 *
 * Side effects:
 *	Memory allocated.
 *
 *--------------------------------------------------------------------------
 */

void
SetArgv(
    char *cmdLine,	// commandline string.
    int *argcPtr,	// Filled with number of argument strings.
    char ***argvPtr)	// Filled with argument strings in UTF (alloc'd with new).
{
    char *p, *arg, *argSpace;
    char **argv;
    int argc, size, inquote, copy, slashes;

    // Precompute an overly pessimistic guess at the number of arguments
    // in the command line by counting non-space spans.
    //
    size = 2;
    for (p = cmdLine; *p != '\0'; p++) {
	if ((*p == ' ') || (*p == '\t')) {	/* INTL: ISO space. */
	    size++;
	    while ((*p == ' ') || (*p == '\t')) { /* INTL: ISO space. */
		p++;
	    }
	    if (*p == '\0') {
		break;
	    }
	}
    }
    argSpace = new char [size + strlen(cmdLine) + 1];
    argv = (char **) argSpace;
    argSpace += size * sizeof(char *);
    size--;

    p = cmdLine;
    for (argc = 0; argc < size; argc++) {
	argv[argc] = arg = argSpace;
	while ((*p == ' ') || (*p == '\t')) {	/* INTL: ISO space. */
	    p++;
	}
	if (*p == '\0') {
	    break;
	}

	inquote = 0;
	slashes = 0;
	while (1) {
	    copy = 1;
	    while (*p == '\\') {
		slashes++;
		p++;
	    }
	    if (*p == '"') {
		if ((slashes & 1) == 0) {
		    copy = 0;
		    if ((inquote) && (p[1] == '"')) {
			p++;
			copy = 1;
		    } else {
			inquote = !inquote;
		    }
                }
                slashes >>= 1;
            }

            while (slashes) {
		*arg = '\\';
		arg++;
		slashes--;
	    }

	    if ((*p == '\0')
		    || (!inquote && ((*p == ' ') || (*p == '\t')))) { /* INTL: ISO space. */
		break;
	    }
	    if (copy != 0) {
		*arg = *p;
		arg++;
	    }
	    p++;
        }
	*arg = '\0';
	argSpace = arg + 1;
    }
    argv[argc] = NULL;

    *argcPtr = argc;
    *argvPtr = argv;
@


1.1.2.5
log
@final cleaning of Tcl from the slavedrv.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.4 2002/03/12 01:38:19 davygrvy Exp $
a29 1
#include "slavedrvmc.h"
a219 143
}


static char sysMsgSpace[1024];

/* local protos */
static TCHAR *Exp95Log (DWORD errCode, char *errData[], int cnt);

#define GETSEVERITY(code)   (UCHAR)((code >> 30) & 0x3) 
#define GETFACILITY(code)   (WORD)((code >> 16) & 0x0FFF)
#define GETCODE(code)	    (WORD)(code & 0xFFFF)

/*
 *----------------------------------------------------------------------
 *
 * ExpWinSyslog --
 *
 *	Logs error messages to the system application event log.
 *	It is normally called through the macro EXP_LOG() when
 *	errors occur in the slave driver process, but it can be
 *	used elsewhere.
 *
 * Results:
 *	None
 *
 *----------------------------------------------------------------------
 */

void
ExpWinSyslog (DWORD errCode, ...)
{
    va_list args;
    char *errData[10];
    int cnt = 0;
    char *errMsg;
    static char codeBuf[33];
    DWORD dwWritten;
    char *file;
    int line;
    static char fileInfo[MAX_PATH];

    va_start(args,errCode);

    /* Get the file info */
    file = va_arg(args, char *);
    line = va_arg(args, int);
    wsprintfA(fileInfo, "%s(%d)", file, line);
    errData[cnt++] = fileInfo;

    /* Set the textual severity */
    switch(GETSEVERITY(errCode)) {
	case STATUS_SEVERITY_WARNING:
	    errData[cnt++] = "Warning"; break;
	case STATUS_SEVERITY_SUCCESS:
	    errData[cnt++] = "Success"; break;
	case STATUS_SEVERITY_INFORMATIONAL:
	    errData[cnt++] = "Info"; break;
	case STATUS_SEVERITY_FATAL:
	    errData[cnt++] = "Fatal"; break;
    }

    /* Set the textual Facility */
    switch(GETFACILITY(errCode)) {
	case FACILITY_WINSOCK:
	    errData[cnt++] = "Winsock IPC"; break;
	case FACILITY_SYSTEM:
	    errData[cnt++] = "System"; break;
	case FACILITY_STUBS:
	    errData[cnt++] = "Stubs"; break;
	case FACILITY_NAMEDPIPE:
	    errData[cnt++] = "NamedPipe IPC"; break;
	case FACILITY_MSPROTO:
	    errData[cnt++] = "Master/Slave Protocol"; break;
	case FACILITY_MAILBOX:
	    errData[cnt++] = "MailBoxing IPC"; break;
	case FACILITY_IO:
	    errData[cnt++] = "I/O general"; break;
	case FACILITY_DBGTRAP:
	    errData[cnt++] = "Debug/Trap"; break;
    }
    /* Set the textual Code */
    errData[cnt++] = codeBuf;
    wsprintfA(codeBuf, "0x%04X", GETCODE(errCode));

    /* set everyone else */
    while ((errData[cnt] = va_arg(args, char *)) != NULL) cnt++;
    va_end(args);

    /* format this error according to the message catalog contained in the exe. */
    errMsg = Exp95Log(errCode, errData, cnt);
    OutputDebugString(errMsg);

    if (GETSEVERITY(errCode) & STATUS_SEVERITY_FATAL) {
	/* I could have used printf() and fflush(), but chose the direct
	 * route instead */
	WriteFile(GetStdHandle(STD_ERROR_HANDLE), errMsg, strlen(errMsg),
		&dwWritten, NULL);

	/* Stop the world, I want to get off. */
	//DebugBreak();

	Sleep(5000);
	ExitProcess(255);
    }

    LocalFree(errMsg);
}

char *ExpSyslogGetSysMsg (DWORD id)
{
    int chars;

    chars = wsprintf(sysMsgSpace, "[%d] ", id);

    FormatMessage(
	    FORMAT_MESSAGE_FROM_SYSTEM |
	    FORMAT_MESSAGE_MAX_WIDTH_MASK,
	    0L,
	    id,
	    0,
	    &sysMsgSpace[chars],
	    (1024-chars),
	    0);

    return sysMsgSpace;
}

char *Exp95Log(DWORD errCode, char *errData[], int cnt)
{
    char *msg;

    FormatMessage(
	    FORMAT_MESSAGE_FROM_HMODULE |
	    FORMAT_MESSAGE_ALLOCATE_BUFFER |
	    FORMAT_MESSAGE_ARGUMENT_ARRAY,
	    GetModuleHandle(NULL),
	    errCode,
	    0,
	    (char *) &msg,
	    0,
	    errData);

    return msg;
@


1.1.2.6
log
@fixed a nasty bug in the SetArgv() function that was all my fault.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.5 2002/03/12 07:59:14 davygrvy Exp $
d139 1
a139 1
    const char *cmdLine,// commandline string.
d143 1
a143 1
    char *arg, *argSpace;
d145 1
a145 3
    const char *p;
    int inquote, copy, slashes;
    size_t size, argc;
d162 1
a162 1
    argSpace = new char [(size * sizeof(char *)) + strlen(cmdLine) + 1];
d217 1
a217 1
    argv[argc] = 0L;
@


1.1.2.7
log
@these changes perfect the debugger code under Win98 and have been sitting in my workspace for quite some time now.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.6 2002/03/16 00:37:01 davygrvy Exp $
d331 1
a331 1
char *GetSysMsg (DWORD id)
@


1.1.2.8
log
@whoops...  use unsigned instead of signed error codes.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.7 2002/06/18 22:51:31 davygrvy Exp $
d335 1
a335 1
    chars = wsprintf(sysMsgSpace, "[%u] ", id);
@


1.1.2.9
log
@titleblock comment changes and removal of the Detours library usage.
@
text
@a17 1
 * Copyright (c) 2003 ActiveState Corporation
d25 1
a25 1
 * RCS: @@(#) $Id: expWinUtils.cpp,v 1.1.2.8 2002/07/03 02:50:05 davygrvy Exp $
@


