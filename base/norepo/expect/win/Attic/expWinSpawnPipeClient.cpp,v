head	1.1;
access;
symbols
	telco-tec-win32-take2-branch:1.1.0.2;
locks; strict;
comment	@// @;


1.1
date	2002.03.11.05.36.05;	author davygrvy;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2002.03.11.05.36.05;	author davygrvy;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2002.03.11.06.53.39;	author davygrvy;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2002.03.12.01.38.19;	author davygrvy;	state Exp;
branches;
next	1.1.2.4;

1.1.2.4
date	2002.03.12.04.37.39;	author davygrvy;	state Exp;
branches;
next	1.1.2.5;

1.1.2.5
date	2002.03.12.07.09.36;	author davygrvy;	state Exp;
branches;
next	1.1.2.6;

1.1.2.6
date	2002.03.12.21.33.26;	author davygrvy;	state dead;
branches;
next	;


desc
@@


1.1
log
@file expWinSpawnPipeClient.cpp was initially added on branch telco-tec-win32-take2-branch.
@
text
@@


1.1.2.1
log
@replacing mailboxing with simple pipes as our transport.
@
text
@a0 23
#include "expWinInt.h"


SpawnPipeClient::SpawnPipeClient(const char *name, CMclQueue<Message> &_mQ)
    : mQ(_mQ)
{
    hStdIn  = GetStdHandle(STD_INPUT_HANDLE);
    hStdOut = GetStdHandle(STD_OUTPUT_HANDLE);
    hStdErr = GetStdHandle(STD_ERROR_HANDLE);
}

void
SpawnPipeClient::Write(Message &what)
{
    DWORD dwWritten;

    switch (what.mode) {
    case Message::TYPE_NORMAL:
	WriteFile(hStdOut, what.bytes, what.length, &dwWritten, 0L);
    case Message::TYPE_ERROR:
	WriteFile(hStdErr, what.bytes, what.length, &dwWritten, 0L);
    }
}
@


1.1.2.2
log
@added missing file header comments
@
text
@d1 1
a1 27
/* ----------------------------------------------------------------------------
 * expWinSpawnPipeClient.cpp --
 *
 *	Simple pipes as our IPC mechanism.
 *
 * ----------------------------------------------------------------------------
 *
 * Written by: Don Libes, libes@@cme.nist.gov, NIST, 12/3/90
 * 
 * Design and implementation of this program was paid for by U.S. tax
 * dollars.  Therefore it is public domain.  However, the author and NIST
 * would appreciate credit if this program or parts of it are used.
 * 
 * Copyright (c) 1997 Mitel Corporation
 *	work by Gordon Chaffee <chaffee@@bmrc.berkeley.edu> for the WinNT port.
 *
 * Copyright (c) 2001-2002 Telindustrie, LLC
 *	work by David Gravereaux <davygrvy@@pobox.com> for any Win32 OS.
 *
 * ----------------------------------------------------------------------------
 * URLs:    http://expect.nist.gov/
 *	    http://expect.sf.net/
 *	    http://bmrc.berkeley.edu/people/chaffee/expectnt.html
 * ----------------------------------------------------------------------------
 * RCS: @@(#) $Id: expWinSlaveTrapDbg.cpp,v 1.1.4.4 2002/03/10 01:02:37 davygrvy Exp $
 * ----------------------------------------------------------------------------
 */
a2 1
#include "expWinInt.h"
a15 1
    HANDLE where;
d19 1
a19 1
	where = hStdOut;
d21 1
a21 1
	where = hStdErr;
a22 2

    WriteFile(where, what.bytes, what.length, &dwWritten, 0L);
@


1.1.2.3
log
@Message class pulled-out to a seperate source file, due to expected growth in that area.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinSpawnPipeClient.cpp,v 1.1.2.2 2002/03/11 06:53:39 davygrvy Exp $
d45 1
a45 1
    switch (what.type) {
@


1.1.2.4
log
@more stuff added to the pipe client component.  slavedrv.exe now sits at a miniature 29,184 bytes :)
@
text
@d9 1
a9 1
 *
d13 1
a13 1
 *
d25 1
a25 1
 * RCS: @@(#) $Id: expWinSpawnPipeClient.cpp,v 1.1.2.3 2002/03/12 01:38:19 davygrvy Exp $
a30 11
class ReadPipe : public CMclThreadHandler
{
public:
    ReadPipe(CMclQueue<Message> &_mQ);
private:
    virtual unsigned ThreadHandlerProc(void);
    CMclQueue<Message> &mQ;
    HANDLE hStdIn;
};


d34 1
a36 1
    new CMclThread(new ReadPipe(_mQ));	    // <- fix this!  save `em somewhere.
a52 33
}

ReadPipe::ReadPipe(CMclQueue<Message> &_mQ)
    : mQ(_mQ)
{
    hStdIn  = GetStdHandle(STD_INPUT_HANDLE);
}

#define READ_BUFFER_SIZE    128

unsigned ReadPipe::ThreadHandlerProc(void)
{
    BOOL ok;
    DWORD dwRead;
    Message &msg = Message();
    BYTE *readBuf;

again:
    readBuf = new BYTE [READ_BUFFER_SIZE];
    ok = ReadFile(hStdIn, readBuf, READ_BUFFER_SIZE, &dwRead, 0L);
    if (!ok || dwRead == 0) {
	CloseHandle(hStdIn);  // <- should this be here?
	delete [] readBuf;
	goto done;
    }
    msg.bytes = readBuf;
    msg.length = dwRead;
    msg.type = Message::TYPE_INSTREAM;
    mQ.Put(msg);
    goto again;

done:
    return 0;
@


1.1.2.5
log
@removed all use of Tcl from the slavedrv.  It was only being used for hash tables.  replaced them with std::map.  It's a bit fatter now, but i'll live.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinSpawnPipeClient.cpp,v 1.1.2.4 2002/03/12 04:37:39 davygrvy Exp $
d29 1
a29 1
#include "expWinSpawnClient.hpp"
d34 1
a34 1
    ReadPipe(CMclQueue<Message *> &_mQ);
d37 1
a37 1
    CMclQueue<Message *> &mQ;
d42 1
a42 1
SpawnPipeClient::SpawnPipeClient(const char *name, CMclQueue<Message *> &_mQ)
d51 1
a51 1
SpawnPipeClient::Write(Message *what)
d56 1
a56 1
    switch (what->type) {
d63 1
a63 1
    WriteFile(where, what->bytes, what->length, &dwWritten, 0L);
d66 1
a66 1
ReadPipe::ReadPipe(CMclQueue<Message *> &_mQ)
d78 1
a78 1
    Message *msg;
d89 3
a91 4
    msg = new Message;
    msg->bytes = readBuf;
    msg->length = dwRead;
    msg->type = Message::TYPE_INSTREAM;
@


1.1.2.6
log
@renamed
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinSpawnPipeClient.cpp,v 1.1.2.5 2002/03/12 07:09:36 davygrvy Exp $
@


