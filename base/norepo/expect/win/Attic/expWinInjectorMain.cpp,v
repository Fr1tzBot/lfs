head	1.1;
access;
symbols
	telco-tec-win32-take2-branch:1.1.0.2;
locks; strict;
comment	@// @;


1.1
date	2002.06.19.04.06.25;	author davygrvy;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2002.06.19.04.06.25;	author davygrvy;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2002.06.19.06.29.23;	author davygrvy;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2002.06.19.06.42.45;	author davygrvy;	state Exp;
branches;
next	1.1.2.4;

1.1.2.4
date	2002.06.20.05.39.45;	author davygrvy;	state Exp;
branches;
next	1.1.2.5;

1.1.2.5
date	2002.06.20.06.43.29;	author davygrvy;	state Exp;
branches;
next	1.1.2.6;

1.1.2.6
date	2002.06.20.20.08.56;	author davygrvy;	state Exp;
branches;
next	1.1.2.7;

1.1.2.7
date	2002.06.20.21.52.53;	author davygrvy;	state Exp;
branches;
next	1.1.2.8;

1.1.2.8
date	2002.06.21.03.01.51;	author davygrvy;	state Exp;
branches;
next	1.1.2.9;

1.1.2.9
date	2002.06.21.22.04.24;	author davygrvy;	state Exp;
branches;
next	1.1.2.10;

1.1.2.10
date	2002.06.22.02.50.09;	author davygrvy;	state Exp;
branches;
next	1.1.2.11;

1.1.2.11
date	2002.06.22.14.02.03;	author davygrvy;	state Exp;
branches;
next	1.1.2.12;

1.1.2.12
date	2002.06.23.09.26.03;	author davygrvy;	state Exp;
branches;
next	1.1.2.13;

1.1.2.13
date	2002.06.25.08.40.50;	author davygrvy;	state Exp;
branches;
next	1.1.2.14;

1.1.2.14
date	2002.06.27.22.51.04;	author davygrvy;	state Exp;
branches;
next	1.1.2.15;

1.1.2.15
date	2003.08.25.23.17.49;	author davygrvy;	state Exp;
branches;
next	1.1.2.16;

1.1.2.16
date	2003.08.26.20.46.52;	author davygrvy;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file expWinInjectorMain.cpp was initially added on branch telco-tec-win32-take2-branch.
@
text
@@


1.1.2.1
log
@minimal starting point for the console event injector dll (the write portion of the ConsoleDebugger class)
@
text
@a0 47
/* ----------------------------------------------------------------------------
 * expWinInjectorMain.cpp --
 *
 *	Console event injector DLL that's loaded into the slave's address space
 *	used by the ConsoleDebugger class for "writing" to the slave.
 *
 * ----------------------------------------------------------------------------
 *
 * Written by: Don Libes, libes@@cme.nist.gov, NIST, 12/3/90
 * 
 * Design and implementation of this program was paid for by U.S. tax
 * dollars.  Therefore it is public domain.  However, the author and NIST
 * would appreciate credit if this program or parts of it are used.
 * 
 * Copyright (c) 1997 Mitel Corporation
 *	work by Gordon Chaffee <chaffee@@bmrc.berkeley.edu> for the WinNT port.
 *
 * Copyright (c) 2001-2002 Telindustrie, LLC
 *	work by David Gravereaux <davygrvy@@pobox.com> for any Win32 OS.
 *
 * ----------------------------------------------------------------------------
 * URLs:    http://expect.nist.gov/
 *	    http://expect.sf.net/
 *	    http://bmrc.berkeley.edu/people/chaffee/expectnt.html
 * ----------------------------------------------------------------------------
 * RCS: @@(#) $Id: expWinSlave.hpp,v 1.1.4.10 2002/03/12 22:36:44 davygrvy Exp $
 * ----------------------------------------------------------------------------
 */

#include "CMcl.h"

// It is documented that it "isn't a good idea to spawn threads from a DllMain".
// Pooie on you; this is what we will do.

BOOL WINAPI
DllMain (HINSTANCE hInst, ULONG ulReason, LPVOID lpReserved)
{
    switch (ulReason) {
    case DLL_PROCESS_ATTACH:
	DisableThreadLibraryCalls(hInst);
	break;

    case DLL_PROCESS_DETACH:
	break;
    }
    return TRUE;
}
@


1.1.2.2
log
@Injector idea more formalized from thought into some code.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.1 2002/06/19 04:06:25 davygrvy Exp $
a31 46
class Injector : public CMclThreadHandler
{
    CMclMailbox *ConsoleDebuggerIPC;
    HANDLE console;
    CMclEvent *interrupt;

public:

    Injector(HANDLE _console, CMclEvent *_interrupt) 
	: console(_console), interrupt(_interrupt), ConsoleDebuggerIPC(0L)
    {}
    
    ~Injector() {}

private:

    virtual unsigned ThreadHandlerProc(void)
    {
	CHAR	boxName[50];
	DWORD	err, dwWritten;
	INPUT_RECORD ir;

	wsprintf(boxName, "ExpectInjector_pid%d", GetCurrentProcessId());
	ConsoleDebuggerIPC = new CMclMailbox(boxName);

	// Check status.
	err = ConsoleDebuggerIPC->Status();
	if (err != NO_ERROR) {
	    // Bad!
	    delete ConsoleDebuggerIPC;
	    return 666;
	}

	while (ConsoleDebuggerIPC->GetAlertable(&ir, interrupt)) {
	    WriteConsoleInput(console, &ir, 1, &dwWritten);
	}

	delete ConsoleDebuggerIPC;
	return 0;
    }
};

CMclEvent interrupt;
CMclThread *injectorThread;
Injector *inject;

a37 2
    HANDLE console;

a40 6

	console = CreateFile("CONOUT$", GENERIC_WRITE,
		FILE_SHARE_READ|FILE_SHARE_WRITE, 0L, OPEN_EXISTING, 0, 0L);

	inject = new Injector(console, &die);
	injectorThread = new CMclThread(inject);
a43 4
	interrupt.Set();
	injectorThread->Wait(INFINITE);
	delete inject;
	delete injectorThread;
@


1.1.2.3
log
@added an RC script for version info.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.2 2002/06/19 06:29:23 davygrvy Exp $
d93 1
a93 1
	inject = new Injector(console, &interrupt);
@


1.1.2.4
log
@one must open the console INPUT buffer to write console events to it, not the SCREEN buffer.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.3 2002/06/19 06:42:45 davygrvy Exp $
a54 2

	// open the mailbox
a64 1
	// forever loop receiving.
d90 2
a91 2
	console = CreateFile("CONIN$", GENERIC_WRITE,
		FILE_SHARE_WRITE, 0L, OPEN_EXISTING, 0, 0L);
@


1.1.2.5
log
@small changes, but still untested.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.4 2002/06/20 05:39:45 davygrvy Exp $
d64 1
a64 2
	    OutputDebugString("Expect's injector DLL could not start IPC.\n");
	    return 0x666;
d67 1
a67 3
	OutputDebugString("Expect's injector DLL loaded into the slave process correctly.\n");

	// forever loop receiving INPUT_RECORDs over IPC.
a68 2
	    // Stuff it into our slave console as if it had been entered
	    // by the user.
d77 1
a77 1
CMclEvent *interrupt;
a79 1
HANDLE console;
d87 1
d92 1
d95 2
a96 2
	interrupt = new CMclEvent();
	inject = new Injector(console, interrupt);
d99 1
d101 1
a101 1
	interrupt->Set();
a102 1
	delete interrupt;
@


1.1.2.6
log
@better error handling.  I think I'll use OutputDebugString() for sending warnings back to the ConsoleDebugger class.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.5 2002/06/20 06:43:29 davygrvy Exp $
d56 2
a57 4
	// Create the shared memory IPC transfer mechanism by name
	// (a mailbox).
	ConsoleDebuggerIPC = 
		new CMclMailbox(10, sizeof(INPUT_RECORD), boxName);
d60 1
a60 12
	switch (err = ConsoleDebuggerIPC->Status()) {
	case NO_ERROR:
	    OutputDebugString("Expect's injector DLL loaded and ready.\n");
	    break;
	case ERROR_ALREADY_EXISTS:
	    OutputDebugString("Expect's injector DLL could not start IPC: "
		    "another mailbox of the same name already exists.\n");
	    break;
	default:
	    OutputDebugString(GetSysMsg(err));
	}

d62 1
d64 1
d68 2
a79 15

    char *GetSysMsg(DWORD id)
    {
	int chars;

	chars = wsprintf(sysMsgSpace,
		"Expect's injector DLL could not start IPC: [%u] ", id);
	FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM |
		FORMAT_MESSAGE_IGNORE_INSERTS |
		FORMAT_MESSAGE_MAX_WIDTH_MASK, 0L, id, 0,
		sysMsgSpace+chars, (512-chars),	0);
	return sysMsgSpace;
    }

    char sysMsgSpace[512];
a105 1
	CloseHandle(console);
@


1.1.2.7
log
@Added OnXDebugString() to the ConsoleDebugger class to handle the
OUTPUT_DEBUG_STRING_EVENT debugger event.  This sends a new
message type called TYPE_WARNING to the output client.  Changed the
stdio client to just send this out on stderr.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.6 2002/06/20 20:08:56 davygrvy Exp $
d90 1
a90 1
    const char *GetSysMsg(DWORD id)
d110 3
@


1.1.2.8
log
@Injector code hook-in, but doesn't yet work.  I don't know why.
The opcodes for loading the DLL are correct.  The opcodes are
written to the sub process memory and run.  I just don't know.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.7 2002/06/20 21:52:53 davygrvy Exp $
a122 1
	/*MessageBox(NULL, "hi mom!", "lala", MB_OK|MB_SETFOREGROUND);*/
@


1.1.2.9
log
@The injector DLL is now loading into the process.  That's the good news.
The bad news is that it's crashing the process.  I decided to commit the
changes anyways with the hope someone can assist.  Even with the
injector doing nothing, we still crash for some unknown reason.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.8 2002/06/21 03:01:51 davygrvy Exp $
d117 6
a123 6
	//DisableThreadLibraryCalls(hInst);
	//console = CreateFile("CONIN$", GENERIC_WRITE,
	//	FILE_SHARE_WRITE, 0L, OPEN_EXISTING, 0, 0L);
	//interrupt = new CMclEvent();
	//inject = new Injector(console, interrupt);
	//injectorThread = new CMclThread(inject);
d126 6
a131 6
	//interrupt->Set();
	//injectorThread->Wait(INFINITE);
	//CloseHandle(console);
	//delete interrupt;
	//delete inject;
	//delete injectorThread;
@


1.1.2.10
log
@Big crash big fixed.  I was restarting the thread AFTER the breakpoint rather
than on top of it.  OutputDebugString() is now passing through, too.  No
connection has been made yet to the IPC server the injector dll is providing.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.9 2002/06/21 22:04:24 davygrvy Exp $
d117 7
a123 6
	DisableThreadLibraryCalls(hInst);
	console = CreateFile("CONIN$", GENERIC_WRITE,
		FILE_SHARE_WRITE, 0L, OPEN_EXISTING, 0, 0L);
	interrupt = new CMclEvent();
	inject = new Injector(console, interrupt);
	injectorThread = new CMclThread(inject);
d126 6
a131 6
	interrupt->Set();
	injectorThread->Wait(INFINITE);
	CloseHandle(console);
	delete interrupt;
	delete inject;
	delete injectorThread;
@


1.1.2.11
log
@More new good stuff.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.10 2002/06/22 02:50:09 davygrvy Exp $
a36 1
    char sysMsgSpace[512];
d102 2
@


1.1.2.12
log
@Upped the mailbox size to 80 slots from 10.  An INPUT_RECORD can't be
too much more that 24 bytes, so this shouldn't hurt active memory.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.11 2002/06/22 14:02:03 davygrvy Exp $
d60 1
a60 1
		new CMclMailbox(80, sizeof(INPUT_RECORD), boxName);
@


1.1.2.13
log
@We can now write to the slave console.  Debugged and working.
slavedrv1.1 was released today from the code of this commit.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.12 2002/06/23 09:26:03 davygrvy Exp $
d51 2
a52 2
	CHAR boxName[50];
	DWORD err, dwWritten;
@


1.1.2.14
log
@slot and slot sizes are shared on both sides.  This ensures there won't be
any errors from different info.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.13 2002/06/25 08:40:50 davygrvy Exp $
a30 1
#include "expWinInjectorIPC.hpp"
d60 1
a60 1
		new CMclMailbox(IPC_NUMSLOTS, IPC_SLOTSIZE, boxName);
d63 9
a71 2
	err = ConsoleDebuggerIPC->Status();
	if (err != NO_ERROR && err != ERROR_ALREADY_EXISTS) {
d73 3
a78 2

	OutputDebugString("Expect's injector DLL loaded and ready.\n");
@


1.1.2.15
log
@these uncommitted edits have been sitting on my desktop for an eternity.

Adds some MS-DOS support but fails to deliver the required hooks to
succeed.
@
text
@d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.14 2002/06/27 22:51:04 davygrvy Exp $
d106 1
d121 1
a122 1
	delete inject;
@


1.1.2.16
log
@titleblock comment changes and removal of the Detours library usage.
@
text
@a18 1
 * Copyright (c) 2003 ActiveState Corporation
d26 1
a26 1
 * RCS: @@(#) $Id: expWinInjectorMain.cpp,v 1.1.2.15 2003/08/25 23:17:49 davygrvy Exp $
@


