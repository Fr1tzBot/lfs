head	1.1;
access;
symbols
	telco-tec-win32-take2-branch:1.1.0.2;
locks; strict;
comment	@// @;


1.1
date	2002.06.27.04.37.51;	author davygrvy;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2002.06.27.04.37.51;	author davygrvy;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2002.06.28.01.26.57;	author davygrvy;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2003.08.26.20.46.53;	author davygrvy;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file expWinTestClientStdio.cpp was initially added on branch telco-tec-win32-take2-branch.
@
text
@@


1.1.2.1
log
@renamed ClientTransport* to be TestClient* as the name is more descriptive.
@
text
@a0 107
/* ----------------------------------------------------------------------------
 * expWinTestClientStdio.cpp --
 *
 *	Simple standard I/O as our client.
 *
 * ----------------------------------------------------------------------------
 *
 * Written by: Don Libes, libes@@cme.nist.gov, NIST, 12/3/90
 *
 * Design and implementation of this program was paid for by U.S. tax
 * dollars.  Therefore it is public domain.  However, the author and NIST
 * would appreciate credit if this program or parts of it are used.
 *
 * Copyright (c) 1997 Mitel Corporation
 *	work by Gordon Chaffee <chaffee@@bmrc.berkeley.edu> for the WinNT port.
 *
 * Copyright (c) 2001-2002 Telindustrie, LLC
 *	work by David Gravereaux <davygrvy@@pobox.com> for any Win32 OS.
 *
 * ----------------------------------------------------------------------------
 * URLs:    http://expect.nist.gov/
 *	    http://expect.sf.net/
 *	    http://bmrc.berkeley.edu/people/chaffee/expectnt.html
 * ----------------------------------------------------------------------------
 * RCS: @@(#) $Id: expWinClientTransportStdio.cpp,v 1.1.2.1 2002/06/23 09:20:40 davygrvy Exp $
 * ----------------------------------------------------------------------------
 */

#include "expWinTestClient.hpp"


class ReadPipe : public CMclThreadHandler
{
public:
    ReadPipe(CMclQueue<Message *> &_mQ)	: mQ(_mQ)
    {
	hStdIn = GetStdHandle(STD_INPUT_HANDLE);
    }

private:

#   define READ_BUFFER_SIZE    128
    virtual unsigned ThreadHandlerProc(void)
    {
	BOOL ok;
	DWORD dwRead;
	Message *msg;
	BYTE *readBuf;

    again:
	readBuf = new BYTE [READ_BUFFER_SIZE];
	ok = ReadFile(hStdIn, readBuf, READ_BUFFER_SIZE, &dwRead, 0L);
	if (!ok || dwRead == 0) {
	    CloseHandle(hStdIn);  // <- should this be here?
	    delete [] readBuf;
	    goto done;
	}
	msg = new Message;
	msg->bytes = (CHAR *) readBuf;
	msg->length = dwRead;
	msg->type = Message::TYPE_INSTREAM;
	mQ.Put(msg);
	goto again;

    done:
	return 0;
    }

    CMclQueue<Message *> &mQ;
    HANDLE hStdIn;
};

ClientStdio::ClientStdio(const char *name, CMclQueue<Message *> &_mQ)
    : mQ(_mQ)
{
    hStdOut = GetStdHandle(STD_OUTPUT_HANDLE);
    hStdErr = GetStdHandle(STD_ERROR_HANDLE);
    reader = new ReadPipe(_mQ);
    readThread = new CMclThread(reader);
}

ClientStdio::~ClientStdio()
{
    DWORD dwExit;

    readThread->GetExitCode(&dwExit);
    if (dwExit == STILL_ACTIVE) {
	readThread->Terminate(128);
    }
}

void
ClientStdio::Write(Message *what)
{
    DWORD dwWritten;
    HANDLE where;

    switch (what->type) {
    case Message::TYPE_NORMAL:
	where = hStdOut; break;
    case Message::TYPE_WARNING:
    case Message::TYPE_ERROR:
	where = hStdErr;
    }
    WriteFile(where, what->bytes, what->length, &dwWritten, 0L);
    delete what;
}
@


1.1.2.2
log
@The ClientInteract class has been created.  It's empty, though.
@
text
@d25 1
a25 1
 * RCS: @@(#) $Id: expWinTestClientStdio.cpp,v 1.1.2.1 2002/06/27 04:37:51 davygrvy Exp $
d73 1
a73 1
ClientStdio::ClientStdio(CMclQueue<Message *> &_mQ)
@


1.1.2.3
log
@titleblock comment changes and removal of the Detours library usage.
@
text
@a17 1
 * Copyright (c) 2003 ActiveState Corporation
d25 1
a25 1
 * RCS: @@(#) $Id: expWinTestClientStdio.cpp,v 1.1.2.2 2002/06/28 01:26:57 davygrvy Exp $
@


